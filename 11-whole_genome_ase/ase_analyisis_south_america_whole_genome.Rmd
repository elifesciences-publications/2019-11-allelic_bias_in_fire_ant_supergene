---
title: "ase_analyisis_south_america_whole_genome.Rmd"
author: "Carlos Martinez Ruiz"
date: "5 July 2019"
output: pdf_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'results/')
``` 
```{r libraries, echo = FALSE, message = FALSE}
#Load all libraries
library(tximport)
library(readr)
library(DESeq2)
library(GenomicRanges)
library(GenomicFeatures)
library(ggplot2)
library(dplyr)

for (package in (.packages()) ) { 
 print(paste("Package", package, "version", package.version(package)))
}
```

## Introduction

This script will analyse the variant specific expression for the supergene South American populations from *Solenopsis invicta*. The RNAseq data used for this analysis was extracted from three different body parts (abdomen, thorax and head) from virgin alate queens and whole body from workers, all from polygyne colonies. All individuals were genotyped prior to RNA extraction to make sure that they are heterozygote Sb/SB for the social supergene. To obtain the variant-specific reads, the RNAseq reads were aligned to the *S.invicta* reference genome (gnG assembly) and the variant specific read counts obtained by running GATK's ASEreadCounter with a VCF file specific for North American populations. In this particular case, the aim is to assess whether we can detect ASE differences between body parts using ASE from the whole genome (previous analyses were performed on the supergene region only). Because we are now using data from the whole genome (with no phase information) we cannot group the SNPs per gene, as they could belong to different haplotypes. We also need to filter out uninformative SNPs where there is no expression in one of the alleles (likely to be a fixed a llele)

## Import variant specific reads into 

The read counts generated by GATK are stored in a csv file, where one of the columns has the read counts for the reference allele (SB) and another one for the alternative (Sb).

```{r load_data_r, message = FALSE}
#Loads the counts by variant generated by GATK. All samples!!
path_to_samples <- "input/"
ase_files_ar <- grep("csv", list.files(path_to_samples), value = TRUE)
ase_files_ar <- paste(path_to_samples, ase_files_ar, sep="" )

#Add names to the samples
names(ase_files_ar) <- gsub(x = ase_files_ar, pattern = "(.+/)([0-9]+[A-Z]+)(_.+)", "\\2", perl = TRUE)

#Remove samples from colony AR117, which had very low mapping scores
ase_files_ar <- ase_files_ar[-grep(x = ase_files_ar, pattern = "117")]
#ase_files_ar <- ase_files_ar[-grep(x = ase_files_ar, pattern = "28")]
#ase_files_ar <- ase_files_ar[-grep(x = ase_files_ar, pattern = "104")]
ase_files_ar

#Load all the files in R as a single table
ase_ar <- do.call(rbind,lapply(ase_files_ar, read.table, header = TRUE, stringsAsFactors = FALSE)) 

#The table loaded contains all ase counts for the AR colonies. This includes different castes (W and Q) and different tissues within queens (Head, Thorax and Abdomen). 
#Each file has different lengths since not all individuals have the same variants.
```

## Load variant specific read counts into R

Parse the dataset to make it compatible for DESeq2 and then filter out SNPs with very few reads (less than 5 in total) and with low reads in one of the alleles only (less than 3 for any allele).
```{r parse_ase_data, message = FALSE}

#Generate new columns with SNP ids and the sample name
ase_ar$snp_id <- paste(ase_ar$contig, ase_ar$position, sep = "_")
ase_ar$sample <- gsub(pattern = "\\.[0-9]+",
                               replacement = "",
                               x = rownames(ase_ar))

#Keep only the columns of interest
ase_ar_parsed <- data.frame(sample = ase_ar$sample, snp_id = ase_ar$snp_id,
                            ref = ase_ar$refCount, alt = ase_ar$altCount)

#Keep only SNPs which are present in all samples
ids_to_keep <- names(which(table(ase_ar_parsed$snp_id) == length(unique(ase_ar_parsed$sample))))
ase_ar_parsed <- ase_ar_parsed[ase_ar_parsed$snp_id %in% ids_to_keep, ]

#Generate a matrix for DESeq2 with the snp ids in the rownames and the sample name in the columns
#For reference alleles first
ase_mat_ref <- matrix(c(ase_ar_parsed$ref),
                      nrow = length(unique(ase_ar_parsed$snp_id)),
                      ncol = length(unique(ase_ar_parsed$sample)),
                      dimnames = list(unique(ase_ar_parsed$snp_id), 
                                      paste0(unique(ase_ar_parsed$sample), "_ref")))

#Get the names of snps with an average read count lower than 3
snps_to_filter_ref <- names(which(apply(ase_mat_ref, 1, mean) < 3))

#For alternative alleles
ase_mat_alt <- matrix(c(ase_ar_parsed$alt),
                      nrow = length(unique(ase_ar_parsed$snp_id)),
                      ncol = length(unique(ase_ar_parsed$sample)),
                      dimnames = list(unique(ase_ar_parsed$snp_id), 
                                      paste0(unique(ase_ar_parsed$sample), "_alt")))

#Get the names of snps with an average read count lower than 3
snps_to_filter_alt <- names(which(apply(ase_mat_alt, 1, mean) < 3))

#Get the amtrix for all counts
ase_mat <- cbind(ase_mat_ref, ase_mat_alt)

#Get a vector of all the snps to remove for low counts and remove them from the main matrix
snps_to_filter <- unique(c(snps_to_filter_alt, snps_to_filter_ref))

ase_mat <- ase_mat[which(!rownames(ase_mat) %in% snps_to_filter), ]

#Generate metadata for DESeq2
whole_sample    <- gsub(x = colnames(ase_mat), pattern = "_.+", replacement = "")
allele          <- gsub(x = colnames(ase_mat), pattern = ".+_", replacement = "")
body_part       <- gsub(x = whole_sample, pattern = "([0-9]+[BC]?Q?)([A-Z])", replacement = "\\2")
colony <- gsub(x = whole_sample, pattern = "([0-9]+)([A-Z]+)",
               replacement = paste0("AR", "\\1"),
               perl = TRUE)
colData_ar <- data.frame(whole_sample, allele, body_part, colony)
rownames(colData_ar) <- colnames(ase_mat)
```

Import data into DESeq2

##DESeq2 analysis

The analysis for the allele specific expression between the alternative and reference alleles is performed in DESeq2. Because the alelle specific counts that are being compared always come from the same sample (and therefore, the same library), performing normalisation would flatten actual differences. The analysis therefore needs to be performed ensuring that the samples are not normalised (more info here<http://rpubs.com/mikelove/ase>). The first analysis will consider 'colony', 'body_part', 'allele' and the interaction between 'allele:body_part'.

```{r interaction_allele:body_part, message = FALSE}
#Get the data into DESeq2, get size factors by body part only (or sample?)
dds_ar_interaction <- DESeqDataSetFromMatrix(countData = ase_mat, colData = colData_ar, design = ~ colony + body_part + allele + allele:body_part)
#Perform the analysis replacing the sizeFactors: 
sizeFactors(dds_ar_interaction) <- rep(1, ncol(ase_mat))
#If using test = LRT, deseq2 performs a test for detecting DE loci, using first a likelihood ratio test (ANOVA-like). This test compares the model ~body_part+allele against a
#reduced model, ~body_part. The p values indicate which genes are significantly DE accross ALL levels of allele. Normalisation
#has been done only by boy_part, as ASE data comes always from the same sample. If test is not specified it runs the usual Wald test for the last element in the design formula (body_part:allele)
dds_deg_ar_interaction_lrt <- DESeq(dds_ar_interaction, test = "LRT", reduced = ~ colony + body_part + allele, betaPrior = FALSE)

#Get results
res_deg_ar_interaction_lrt <- results(dds_deg_ar_interaction_lrt)
#How many DEG with interaction?
length(which(res_deg_ar_interaction_lrt$padj < 0.05))
#7
```
Out of the 2599 genes analysed, 7 show allele specific expression differences between body parts.

##Variant specific vs body part comparisons

Plot the interaction of body part:allele for visual confirmation of the previous results. It could be that the LRT is not powerful enough to detect most of the ASE. 

```{r plot_allele:body_part_interaction, message = FALSE}
#Get coefficients for interactions only (that is, the main 'allele' effect will be implicit in the interaction term of each body part)
dds_ar_coef <- DESeqDataSetFromMatrix(countData = ase_mat, colData = colData_ar, design = ~ colony + body_part + allele:body_part)
#Perform the analysis replacing the sizeFactors: 
sizeFactors(dds_ar_coef) <- rep(1, ncol(ase_mat))
dds_deg_ar_coef <- DESeq(dds_ar_coef, betaPrior = FALSE)
res_deg_ar_coef <- results(dds_deg_ar_coef)

coef_QA <- coefficients(dds_deg_ar_coef)[, "body_partA.alleleref"]
coef_QT <- coefficients(dds_deg_ar_coef)[, "body_partT.alleleref"]
coef_QH <- coefficients(dds_deg_ar_coef)[, "body_partH.alleleref"]
coef_W  <- coefficients(dds_deg_ar_coef)[, "body_partW.alleleref"]

#Plot weihting points by read count mean, add line with linear regression, weighted by counts
#Weight for the point size, by log(mean counts per gene), scaled up to fit 0-1 range
cex_weights <- (log(res_deg_ar_coef$baseMean) - min(log(res_deg_ar_coef$baseMean)))/
  (max(log(res_deg_ar_coef$baseMean))-min(log(res_deg_ar_coef$baseMean)))
par(mfrow = c(3, 2), cex.lab = 2, cex.axis = 2)
plot(coef_QA, coef_QT, type = "n", xlab = "Queen Abdomen LFCs", ylab = "Queen Thorax LFCs")
points(coef_QA, coef_QT, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_QT ~ coef_QA, weights = res_deg_ar_coef$baseMean), col = "red")

plot(coef_QA, coef_QH, type = "n", xlab = "Queen Abdomen LFCs", ylab = "Queen Head LFCs")
points(coef_QA, coef_QH, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_QH ~ coef_QA, weights = res_deg_ar_coef$baseMean), col = "red")

plot(coef_QA, coef_W, type = "n", xlab = "Queen Abdomen LFCs", ylab = "Worker LFCs")
points(coef_QA, coef_W, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_W ~ coef_QA, weights = res_deg_ar_coef$baseMean), col = "red")

plot(coef_QH, coef_W, type = "n", xlab = "Queen Head LFCs", ylab = "Worker LFCs")
points(coef_QH, coef_W, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_W ~ coef_QH, weights = res_deg_ar_coef$baseMean), col = "red")

plot(coef_QT, coef_W, type = "n", xlab = "Queen Thorax LFCs", ylab = "Worker LFCs")
points(coef_QT, coef_W, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_W ~ coef_QT, weights = res_deg_ar_coef$baseMean), col = "red")

plot(coef_QT, coef_QH, type = "n", xlab = "Queen Thorax LFCs", ylab = "Queen Head LFCs")
points(coef_QT, coef_QA, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_QA ~ coef_QT, weights = res_deg_ar_coef$baseMean), col = "red")
par(mfrow = c(1,1))
```

There seems to be more differences between workers and queen body parts (and fewer but strong differences between some queen body parts). The LRT showed very few differences in terms of ASE between castes/body parts. Here we run a pairwise Wald test comparing each interaction to the reference level (allelealt, i.e. the effect of the alternative) to double check the significance of ase across body parts/caste
```{r pairwise_comparisons_allele:body_part_interaction, message = FALSE}
#Extract all the names for potential contrasts, keep only the interactions (in this model, main variant effects + interactions)
dds_deg_ar_coef <- DESeq(dds_ar_coef, betaPrior = FALSE)
coef_names <- resultsNames(dds_deg_ar_coef)
coef_interactions <- grep(pattern = "body_part[A-Z]\\.alleleref", x = coef_names, value = TRUE)

#Run the Wald tests for each coefficient (this will compare each coefficient with each other)
#Get all possible contrasts (all combination of elements in 'coef_interactions', 2 at a time)
all_contrasts <- combn(x = c(1:length(coef_interactions)), m = 2)
#Transpose the matrix of contrasts so that it can be read in the for loop
all_contrasts <- t(all_contrasts)

#Run loop for all contrasts of interactions
#Generate empty matrix to store all results
all_pvals_interactions <- matrix(NA, ncol = 3, dimnames = list(NULL, c("snp", "contrast", "padj")))

for(this_contrast in 1:nrow(all_contrasts)){
  #Select the coefficients for the contrast
  coef_one <- all_contrasts[this_contrast, 1]
  coef_one <- coef_interactions[coef_one]
  coef_two <- all_contrasts[this_contrast, 2]
  coef_two <- coef_interactions[coef_two]
  #Run the contrast through DESeq2
  this_result <- results(dds_deg_ar_coef, contrast = list(coef_one, coef_two))
  #Get p values for that contrast
  all_pvals <- this_result$padj
  #Get all gene names
  all_genes <- rownames(this_result)
  #Get the contrast
  these_coefs <- rep(paste0(coef_one, "_vs_", coef_two), nrow(this_result))
  #Add all data to the main matrix
  all_pvals_interactions <- rbind(all_pvals_interactions, matrix(c(all_genes, these_coefs, all_pvals), ncol = 3))
}
#Transform into data frame
all_pvals_interactions <- data.frame(all_pvals_interactions, stringsAsFactors = FALSE)
#Remove NAs from first row
all_pvals_interactions <- all_pvals_interactions[rowSums(is.na(all_pvals_interactions)) != ncol(all_pvals_interactions), ]
#Make sure the numeric variable is numeric
all_pvals_interactions$padj <- as.numeric(all_pvals_interactions$padj)

#Which snps are significant (alpha = 0.05)?
sig_snps <- all_pvals_interactions[which(all_pvals_interactions$padj < 0.05), ]
length(unique(sig_snps$snp))
```

Pairwise Wald tests show that 105 out of the 2599 snps analysed show ASE.
How well distributed are those snps? Could it be that is all down to a few scaffolds?

```{r sig_snps_scaffolds, message = FALSE}
#Get the name of the scaffolds with significant snps
sig_scaffolds <- unique(sig_snps$snp)
sig_scaffolds <- gsub(pattern = "_[0-9]+$",
                      replacement = "",
                      x = sig_scaffolds)
nb_sig_scaff <- length(unique(sig_scaffolds))

#Get the name of all scaffolds analysed
all_scaffolds <- unique(all_pvals_interactions$snp)
all_scaffolds <- gsub(pattern = "_[0-9]+$",
                      replacement = "",
                      x = all_scaffolds)
nb_all_scaff <- length(unique(all_scaffolds))
#Number of sig snps
nb_sig_snps <- length(unique(sig_snps$snp))

#Number of total snps
nb_all_snps <- length(unique(all_pvals_interactions$snp))

#Is there an enrichment of significant snps in a few scaffolds?
to_chi_scaff <- matrix(c((nb_all_snps - nb_sig_snps), (nb_all_scaff - nb_sig_scaff), nb_sig_snps, nb_sig_scaff), nrow = 2,
                       dimnames = list(c("snps", "scaffolds"), c("non_sig", "sig")))
to_chi_scaff
chisq.test(to_chi_scaff)

```

This is a very significant result, but rather than enrichment, it shows depletion. The significant snps are over-dispersed across more scaffolds than expected by chance
Re-create the plot above, but colouring in red the snps for significant comparisons

```{r plot_allele:body_part_interaction_sig_snps, message = FALSE}
#Get coefficients for interactions only (that is, the main 'allele' effect will be implicit in the interaction term of each body part)
dds_ar_coef <- DESeqDataSetFromMatrix(countData = ase_mat, colData = colData_ar, design = ~ colony + body_part + allele:body_part)
#Perform the analysis replacing the sizeFactors: 
sizeFactors(dds_ar_coef) <- rep(1, ncol(ase_mat))
dds_deg_ar_coef <- DESeq(dds_ar_coef, betaPrior = FALSE)
res_deg_ar_coef <- results(dds_deg_ar_coef)


coef_QA <- coefficients(dds_deg_ar_coef)[, "body_partA.alleleref"]
coef_QT <- coefficients(dds_deg_ar_coef)[, "body_partT.alleleref"]
coef_QH <- coefficients(dds_deg_ar_coef)[, "body_partH.alleleref"]
coef_W  <- coefficients(dds_deg_ar_coef)[, "body_partW.alleleref"]

#Plot weihting points by read count mean, add line with linear regression, weighted by counts
#Weight for the point size, by log(mean counts per gene), scaled up to fit 0-1 range
cex_weights <- (log(res_deg_ar_coef$baseMean) - min(log(res_deg_ar_coef$baseMean)))/
  (max(log(res_deg_ar_coef$baseMean))-min(log(res_deg_ar_coef$baseMean)))
par(mfrow = c(3, 2), cex.lab = 2, cex.axis = 2)
#Add red colour for significant snp in specific comparisons (black if not sig)
cols_QA_QT <- ifelse(all_pvals_interactions$padj[all_pvals_interactions$contrast == "body_partA.alleleref_vs_body_partT.alleleref"] < 0.05, "red", "black")
cols_QA_QT[is.na(cols_QA_QT)] <- "black"
plot(coef_QA, coef_QT, type = "n", xlab = "Queen Abdomen LFCs", ylab = "Queen Thorax LFCs", xlim = c(-20, 30), ylim = c(-20, 30))
points(coef_QA, coef_QT, col = cols_QA_QT, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_QT ~ coef_QA, weights = res_deg_ar_coef$baseMean), col = "red")

#Add red colour for significant snp in specific comparisons (black if not sig)
cols_QA_QH <- ifelse(all_pvals_interactions$padj[all_pvals_interactions$contrast == "body_partA.alleleref_vs_body_partH.alleleref"] < 0.05, "red", "black")
cols_QA_QH[is.na(cols_QA_QH)] <- "black"
plot(coef_QA, coef_QH, type = "n", xlab = "Queen Abdomen LFCs", ylab = "Queen Head LFCs" , xlim = c(-20, 30), ylim = c(-20, 30))
points(coef_QA, coef_QH, col = cols_QA_QH, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_QH ~ coef_QA, weights = res_deg_ar_coef$baseMean), col = "red")

#Add red colour for significant snp in specific comparisons (black if not sig)
cols_QA_W <- ifelse(all_pvals_interactions$padj[all_pvals_interactions$contrast == "body_partA.alleleref_vs_body_partW.alleleref"] < 0.05, "red", "black")
cols_QA_W[is.na(cols_QA_W)] <- "black"
plot(coef_QA, coef_W, type = "n", xlab = "Queen Abdomen LFCs", ylab = "Worker LFCs" , xlim = c(-20, 30), ylim = c(-20, 30))
points(coef_QA, coef_W, col = cols_QA_W, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_W ~ coef_QA, weights = res_deg_ar_coef$baseMean), col = "red")

#Add red colour for significant snp in specific comparisons (black if not sig)
cols_QH_W <- ifelse(all_pvals_interactions$padj[all_pvals_interactions$contrast == "body_partH.alleleref_vs_body_partW.alleleref"] < 0.05, "red", "black")
cols_QH_W[is.na(cols_QH_W)] <- "black"
plot(coef_QH, coef_W, type = "n", xlab = "Queen Head LFCs", ylab = "Worker LFCs" , xlim = c(-20, 30), ylim = c(-20, 30))
points(coef_QH, coef_W, col = cols_QH_W, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_W ~ coef_QH, weights = res_deg_ar_coef$baseMean), col = "red")

#Add red colour for significant snp in specific comparisons (black if not sig)
cols_QT_W <- ifelse(all_pvals_interactions$padj[all_pvals_interactions$contrast == "body_partT.alleleref_vs_body_partW.alleleref"] < 0.05, "red", "black")
cols_QT_W[is.na(cols_QT_W)] <- "black"
plot(coef_QT, coef_W, type = "n", xlab = "Queen Thorax LFCs", ylab = "Worker LFCs" , xlim = c(-20, 30), ylim = c(-20, 30))
points(coef_QT, coef_W, col = cols_QT_W, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_W ~ coef_QT, weights = res_deg_ar_coef$baseMean), col = "red")

#Add red colour for significant snp in specific comparisons (black if not sig)
cols_QT_QH <- ifelse(all_pvals_interactions$padj[all_pvals_interactions$contrast == "body_partH.alleleref_vs_body_partT.alleleref"] < 0.05, "red", "black")
cols_QT_QH[is.na(cols_QT_QH)] <- "black"
plot(coef_QT, coef_QH, type = "n", xlab = "Queen Thorax LFCs", ylab = "Queen Head LFCs" , xlim = c(-20, 30), ylim = c(-20, 30))
points(coef_QT, coef_QH, col = cols_QT_QH, cex = 2*cex_weights, pch = 20)
abline(0,1)
abline(lm(coef_QA ~ coef_QT, weights = res_deg_ar_coef$baseMean), col = "red")
par(mfrow = c(1,1))
```
